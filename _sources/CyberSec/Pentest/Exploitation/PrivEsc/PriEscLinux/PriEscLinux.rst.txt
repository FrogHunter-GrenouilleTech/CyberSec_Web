============================
Privilege escalation - Linux
============================

.. index::
   single: Privilege Escalation; Privilege Escalation - Linux

.. contents::
    :backlinks: top


####

A lot of devices running on Linux.

    .. note::

       Examples of devices that are very likely to run a Linux operating system are :

        * Firewalls
        * Routers
        * VOIP servers
        * NAS
        * Web servers
    
These kinds of devices are very critical for a company’s infrastructure with severe consequences
when they are compromised.

It happens very often that system administrators in Windows environments overlook the Linux devices
for many reasons. One of these reasons is the lack of knowledge about how to maintain Linux systems
and how to secure them. This can result in critical Linux devices being the weakest link in the
security chain and become a great security threat.

Therefore, it is very important as a penetration tester to focus not only on Windows systems because
they cover 90% of the company’s devices but also on (critical) Linux systems.

The most common ways of privilege escalation on Linux systems are leveraging kernel vulnerabilities,
misconfigurations and vulnerable software to execute arbitrary code under root privileges. New
kernel vulnerabilities occur on a regular basis and often involve a wide range of kernel versions.
A recently discovered example of a kernel vulnerability allowing for privilege escalation is the
**DirtyCOW vulnerability** affecting hundreds of Linux kernel versions. Also misconfigurations in
files, services and security mechanisms and out of date software commonly allow for privilege
escalation.

    .. note:: 
        
        **Liens Web**

    * `hacktricks - Linux Privilege Escalation`_
    
.. _`hacktricks - Linux Privilege Escalation`: https://book.hacktricks.xyz/linux-hardening/privilege-escalation


####

--------------------------------------
Collecting system information manually
--------------------------------------

Nearly every step of a Pentest is related to the **Enumeration**. The privilege escalation doesn't
make exception. Collecting relevant system information can be useful for privilege escalation such
as the kernel version, running services, installed applications and file permissions.

This will not only help us to gain a better understanding of how a system is configured but also to
know which applications and services are running on the host. Services running with root privileges
are of especial interest for privilege escalation. When we can exploit a service running as root to
execute arbitrary commands they will be executed as root. Applications that are configured to be
executed with higher privileges using a Linux feature named SUID are also very useful.

    .. note:: 
        
       For effective privilege escalation in Linux the system information you should know includes:

            * Distribution type
            * Kernel version
            * Running applications and services
            * Weak file permissions
            * Scheduled jobs
            * Other important information about the system. 

Collecting system information can be done both manually and automatically with scripts. The use of
automated scripts generally saves you a lot of time, but the information collected will be limited
to that which the script is programmed to retrieve. For example, if a script is not designed to
retrieve active connections then you may never find out about that one critical port running an
admin interface which is only accessible locally.

Linux command to get system information
=======================================

OS, Kernel & Hostname
---------------------

    .. note:: 
        
        The following commands print the operating system, kernel version, hostname and system
        information to the terminal.

        .. code:: inputLanguage
            :number-lines:
            :force:

             cat /etc/issue
             cat /proc/version
             hostname
             uname -a

        .. image:: images/Linux-local-enumeration1.jpg
           :width: 500 px
           :align: center

        This information acquired can be used to check the Linux distribution and kernel for known
        vulnerabilities, for instance, on Exploit-db or with searchsploit.

It is also highly recommended to search the OS version in Google or Exploit-db for available
(kernel) exploits. This sometimes produces better search results.

    .. note:: 
        
        The following example concerns a machine with kernel version **3.10.0-123 on CentOS
        7.0.1406** which is vulnerable to **CVE2014-3153**
        
        .. code:: shell
            :number-lines:
            :force:

             cat /etc/centos-release

        .. image:: images/PE-OS-Version-03-2.jpg
           :width: 500 px
           :align: center

Searching for the specific kernel version does not immediately return useful search results for
privilege escalation exploits.

    .. note:: 
        
        Searching on the OS version for privilege escalation exploits does provide some interesting
        results.

        .. image:: images/PE-OS-Version-01.jpg
           :width: 500 px
           :align: center

Another good approach is to search Exploit-DB on the kernel version (or any identified software)
from narrow to wide with the "local" filter to ensure the exploits are local exploits only.

    .. note:: 
        
        For Linux Kernel 3.10.0-123
        
        .. code:: shell
            :number-lines:
            :force:

             Linux kernel 3.10.0-123 // No results.
             Linux kernel 3.10.0     // 1 local exploit matching the kernel version.
             Linux kernel 3.10       // No results that match the CentOS 7 operating system.

        The following search looks for Linux kernels starting with "Linux Kernel 3.1", which is
        actually actually kernel version 3.1 and above.

        .. code:: shell
            :number-lines:
            :force:

             Linux kernel 3.1

        This search returns 2 new results that match the OS version: **Libfutex** and **Remount FUSE**

        .. image:: images/linuxKernel3.1.jpg
            :width: 500 px
            :align: center

        The search results page shows 13 more entries that match our search, but they can be
        discarded because they don't match the Kernel or operating system version.

Users
-----

The next commands can be used to retrieve information related to system users, active sessions and
the current user.

    .. note:: 
        
        **passwd**

        The **passwd file** stores essential user account information required during login. The
        passwd file is stored in the **/etc** directory and contains information such as :
        
            * user ID
            * group ID
            * home directory
            * the path to the command shell.
            
        An ‘x’ character means that the encrypted password is stored in the /etc/shadow file.
        
        .. code:: shell
            :number-lines:
            :force:

             cat /etc/passwd

        .. image:: images/image149.png
           :width: 500 px
           :align: center


    .. note:: 
        
        **Current User and active session**
        
        .. code:: shell
            :number-lines:
            :force:

             id
             who
             w

        .. image:: images/image150.png
           :width: 500 px
           :align: center


Make sure you pay attention to the groups to which the privileged user belongs. One especially
important group is the **sudo (‘Super User Do’) group**. A user that is member of the sudo group is
able to execute commands in the context of the root user without providing the root password.
Depending on the settings in the sudoer file you may only need to enter the password for the current
user or none at all.

    .. note:: 
        
        **display a list of commands as super.**

        When the user is part of the sudo group you can display a list of commands that can be
        executed as super.
        
        .. code:: shell
            :number-lines:
            :force:

             sudo -l

        .. image:: images/sudo-l-root.jpg
           :width: 500 px
           :align: center

The sudo command on Linux is very configurable. Instead of allowing a limited user to execute all
commands as root, it is possible to limit a user’s sudo privileges to certain commands by
whitelisting them in the /etc/sudoers file.

    .. note:: 
        
        The following line in the sudoers file, for instance, will allow the root privileges for a
        user called ‘useraccount’ to execute apt-get and shutdown.
        
        .. code:: shell
            :number-lines:
            :force:

             useraccount ALL=/usr/bin/apt-get,/sbin/shutdown

        .. image:: images/sudo-l-user.jpg
           :width: 500 px
           :align: center

Networking information
----------------------

The following commands retrieve networking information such as the available network adapters and
configuration, routes, active connections and other network related information.

    .. note:: 
        
        **Network adapters**
        
        .. code:: shell
            :number-lines:
            :force:

             ipconfig -a

        .. image:: images/image151.png
           :width: 500 px
           :align: center


    .. note:: 
        
        **print the routing table**
        
        .. code:: shell
            :number-lines:
            :force:

             route

        .. image:: images/image152.png
           :width: 500 px
           :align: center


    .. note:: 
        
        **print the active connections to the terminal**
        
        .. code:: shell
            :number-lines:
            :force:

             netstat -antup

        .. image:: images/image153.png
           :width: 500 px
           :align: center


    .. note:: 
        
        **prints the ARP table**
        
        .. code:: shell
            :number-lines:
            :force:

             arp -e

        .. image:: images/image154.png
           :width: 500 px
           :align: center

Applications and services
-------------------------

These commands retrieve information about applications and services.

Knowing which services are running with root privileges can be very important for privilege
escalation because exploiting them will result in root level access.

    .. note:: 
        
        .. code:: shell
            :number-lines:
            :force:

             ps aux

        .. image:: images/image155.png
           :width: 500 px
           :align: center


    .. note:: 
        
        **retrieve installed applications**
        
        .. code:: shell
            :number-lines:
            :force:

             # Debian and derivative
             dpkg -l

             # Fedora based distros
             rpm -qa

        .. image:: images/image156.png
           :width: 500 px
           :align: center


Configurations files may contains sensitive information about applications and services which can
also be very useful information for privilege escalation purposes.

    .. note:: 
        
        **list configuration files in the /etc directory**
        
        .. code:: shell
            :number-lines:
            :force:

             ls -ls /etc/ | grep .conf

        .. image:: images/image157.png
           :width: 500 px
           :align: center


Also try searching the web directory for any web application configuration files that contain
passwords.

    .. note:: 
        
        **Title**
        
        .. code:: shell
            :number-lines:
            :force:

             ls -ls /var/www/html/

        .. image:: images/priv-esca-linux-web-dirs.jpg
           :width: 500 px
           :align: center

    .. important:: 
        
        **Hint**

        Joomla installations contain a configuration file named **‘configuration.php’** and
        WordPress uses the ‘wp-config.php’ file for this purpose. These configuration files contain
        valuable information such as the MySQL username and password. If you encounter web
        applications on a compromised host, be sure to check their configuration files for
        information that can be used for privilege escalation. It is very common for web admins to
        re-use passwords on other accounts.

Automated Scripts
=================

Instead of manually searching for vulnerabilities and misconfigurations for privilege escalation,
you can also use scripts to automate the process of collecting system information and testing for vulnerabilities. Some of the scripts even suggest exploits based on the information they find.

    * :ref:`LinPEAS <ref_LinPEAS>`


####

--------
Weblinks
--------

.. target-notes::